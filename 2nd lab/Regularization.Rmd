---
title: 'Parte 3: Predição'
author: "Luiz Fonseca"
date: "7 de dezembro de 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# setwd("/home/luiz/Faculdade/Predictive-Data-Analysis/2nd lab/")
```

Primeiro vamos carregar os dados e bibliotecas que serão utilizados.

```{r, results='hide', message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(reshape2)
library(caret)
# library(leaps)

students.train.data <- read.csv("data/graduados_treino.csv")
students.test.data <- read.csv("data/graduados_teste.csv")
```

## Entendendo o problema e os dados

O objetivo deste exercício é construir modelos preditivos de regressão utilizando técnicas de regularização e seleção de variáveis para a predição do CRA baseados nas disciplinas do primeiro e segundo semestres. Os dados são sobre os alunos do Curso de Ciência da Computação da Universidade Federal de Campina Grande. Os dados fornecidos foram divididos em dados de treinos e de teste, entretanto, depois de algum processamento para ajustar os dados para servirem como entrada para o método de regularização, os dados de treino acabaram ficando com menos amostras do que os dados de teste. Por essa razão, eu decidi unir os dados, e depois do processamento, repartí-los novamente em dados de treino e de teste.

## Preprocessamento dos dados
```{r}
# Une dados de treino e de teste
alunos.dados.completos <- rbind(students.train.data, students.test.data)

# Renomea as colunas
names(alunos.dados.completos) <- c("matricula", "ano_formatura", "periodo_formatura",
                                "cod_disciplina", "disciplina", "creditos", "media")

# Retira os valores NA das médias
alunos.dados.completos <- alunos.dados.completos %>% 
  filter(!is.na(media))

# Calcula o CRA de cada aluno
alunos.cra <- alunos.dados.completos %>%
  group_by(matricula) %>%
  mutate(cra.contrb = media*creditos) %>%
  summarise(cra = round(sum(cra.contrb)/sum(creditos), 2))

disciplinas.iniciais <- c(
  "Cálculo Diferencial e Integral I",
  "Álgebra Vetorial e Geometria Analítica",
  "Leitura e Produção de Textos",
  "Programação I",
  "Introdução à Computação",
  "Laboratório de Programação I",
  "Cálculo Diferencial e Integral II",
  "Matemática Discreta",
  "Programação II",
  "Teoria dos Grafos",
  "Fundamentos de Física Clássica",
  "Laboratório de Programação II"
  )

# Transforma o dataframe em um formato ideal para ser utilizado como entrada do modelo
alunos.dados.completos <- alunos.dados.completos %>%
  filter(disciplina %in% disciplinas.iniciais) %>%
  group_by(matricula,disciplina)  %>%
  filter(media == max(media)) %>%
  ungroup() %>%
  select(matricula,disciplina,media) %>% 
  mutate(disciplina = as.factor(gsub(" ",".",disciplina))) %>%
  dcast(matricula ~ disciplina, mean) %>%
  merge(alunos.cra) %>%
  na.omit()

split <- createDataPartition(y=alunos.dados.completos$cra, p = 0.7, list = FALSE)
alunos.treino <- alunos.dados.completos[split,]
alunos.teste <- alunos.dados.completos[-split,]

# names(graduados.dados.treino)[2:13] <-sort(disciplinas.iniciais) 

```

## Atividades
<ol>
<li><b>Usando todas as variáveis disponíveis (disciplinas do primeiro e segundo período), use validação cruzada (nos dados de treino) para tunar um modelo de regressão Ridge. <b></li>

```{r}
fitControl <- trainControl(method = "cv",
                           number = 10)

lambdaGrid <- expand.grid(lambda = 10^seq(10, -2, length=100))

ridge.fit <- train(cra ~. -matricula,
                   data = graduados.dados.treino,
                   trControl = fitControl,
                   method='ridge',
                   tuneGrid = lambdaGrid,
                   preProcess=c('scale', 'center'),
                   na.action = na.omit)
```

</ol>